kubectl apply --wait -f \
	nginx.deploy.root.yaml,nginx.pvc.yaml
deployment.apps/nginx-test created
persistentvolumeclaim/nginx-test created
while ! kubectl get pod -o json | jq -e '[.items[].status.phase]  == ["Running"]'; do sleep 2; done
false
false
true
kubectl apply --wait -f \
	nginx.deploy.broken.yaml
deployment.apps/nginx-test configured
while ! kubectl get pod -o json | jq -e '[.items[].status.phase]  == ["Running"]'; do sleep 2; done
false
false
false
false
false
true
kubectl logs --all-containers --prefix --tail=64 \
	-l app.kubernetes.io/instance=nginx
[pod/nginx-test-57fd69f956-q6lxj/init-storage] /storage:
[pod/nginx-test-57fd69f956-q6lxj/init-storage] total 24K    
[pod/nginx-test-57fd69f956-q6lxj/init-storage] drwxrwxrwx    3 500      501         4.0K Mar  1 05:52 .
[pod/nginx-test-57fd69f956-q6lxj/init-storage] drwxr-xr-x    1 root     root        4.0K Mar  1 05:53 ..
[pod/nginx-test-57fd69f956-q6lxj/init-storage] -rw-r--r--    1 400      401            8 Mar  1 05:52 chmodfile
[pod/nginx-test-57fd69f956-q6lxj/init-storage] drwxr-xr-x    3 400      401         4.0K Mar  1 05:52 foo
[pod/nginx-test-57fd69f956-q6lxj/init-storage] -rw-r--r--    1 400      401            5 Mar  1 05:52 oldfile
[pod/nginx-test-57fd69f956-q6lxj/init-storage] -rw-r--r--    1 400      401            9 Mar  1 05:52 rmfile
[pod/nginx-test-57fd69f956-q6lxj/init-storage] 
[pod/nginx-test-57fd69f956-q6lxj/init-storage] /storage/foo:
[pod/nginx-test-57fd69f956-q6lxj/init-storage] total 16K    
[pod/nginx-test-57fd69f956-q6lxj/init-storage] drwxr-xr-x    3 400      401         4.0K Mar  1 05:52 .
[pod/nginx-test-57fd69f956-q6lxj/init-storage] drwxrwxrwx    3 500      501         4.0K Mar  1 05:52 ..
[pod/nginx-test-57fd69f956-q6lxj/init-storage] dr--------    2 400      401         4.0K Mar  1 05:52 bar
[pod/nginx-test-57fd69f956-q6lxj/init-storage] -rw-r--r--    1 400      401            5 Mar  1 05:52 quux
[pod/nginx-test-57fd69f956-q6lxj/init-storage] 
[pod/nginx-test-57fd69f956-q6lxj/init-storage] /storage/foo/bar:
[pod/nginx-test-57fd69f956-q6lxj/init-storage] total 12K    
[pod/nginx-test-57fd69f956-q6lxj/init-storage] dr--------    2 400      401         4.0K Mar  1 05:52 .
[pod/nginx-test-57fd69f956-q6lxj/init-storage] drwxr-xr-x    3 400      401         4.0K Mar  1 05:52 ..
[pod/nginx-test-57fd69f956-q6lxj/init-storage] -r--------    1 400      401            4 Mar  1 05:52 baz
[pod/nginx-test-57fd69f956-q6lxj/nginx] /docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
[pod/nginx-test-57fd69f956-q6lxj/nginx] /docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/
[pod/nginx-test-57fd69f956-q6lxj/nginx] /docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
[pod/nginx-test-57fd69f956-q6lxj/nginx] 10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf
[pod/nginx-test-57fd69f956-q6lxj/nginx] 10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf
[pod/nginx-test-57fd69f956-q6lxj/nginx] /docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
[pod/nginx-test-57fd69f956-q6lxj/nginx] /docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
[pod/nginx-test-57fd69f956-q6lxj/nginx] /docker-entrypoint.sh: Configuration complete; ready for start up
[pod/nginx-test-57fd69f956-q6lxj/nginx] 2022/03/01 05:53:02 [notice] 1#1: using the "epoll" event method
[pod/nginx-test-57fd69f956-q6lxj/nginx] 2022/03/01 05:53:02 [notice] 1#1: nginx/1.21.6
[pod/nginx-test-57fd69f956-q6lxj/nginx] 2022/03/01 05:53:02 [notice] 1#1: built by gcc 10.3.1 20211027 (Alpine 10.3.1_git20211027) 
[pod/nginx-test-57fd69f956-q6lxj/nginx] 2022/03/01 05:53:02 [notice] 1#1: OS: Linux 5.4.170+
[pod/nginx-test-57fd69f956-q6lxj/nginx] 2022/03/01 05:53:02 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576
[pod/nginx-test-57fd69f956-q6lxj/nginx] 2022/03/01 05:53:02 [notice] 1#1: start worker processes
[pod/nginx-test-57fd69f956-q6lxj/nginx] 2022/03/01 05:53:02 [notice] 1#1: start worker process 34
[pod/nginx-test-57fd69f956-q6lxj/nginx] 2022/03/01 05:53:02 [notice] 1#1: start worker process 35
[pod/nginx-test-57fd69f956-q6lxj/nginx] 2022/03/01 05:53:02 [notice] 1#1: start worker process 36
[pod/nginx-test-57fd69f956-q6lxj/nginx] 2022/03/01 05:53:02 [notice] 1#1: start worker process 37
kubectl apply --wait -f \
	nginx.deploy.rootless.yaml
deployment.apps/nginx-test configured
while ! kubectl get pod -o json | jq -e '[.items[].status.phase]  == ["Running"]'; do sleep 2; done
false
false
false
false
true
kubectl logs --prefix --tail=64 \
	-l app.kubernetes.io/instance=nginx \
	-c fix-storage-permissions
kubectl exec \
	$(kubectl get pod -o json | jq -r '.items[0].metadata.name') \
	-- sh -c 'touch /app/web/sites/default/files/newfile; mkdir -p /app/web/sites/default/files/new/dir; chmod 777 /app/web/sites/default/files/chmodfile; rm -f /app/web/sites/default/files/rmfile; ls -lahR /app/web/sites/default/files'
/app/web/sites/default/files:
total 24K    
drwxrwxrwx    4 10000    root        4.0K Mar  1 05:53 .
drwxr-xr-x    3 root     root        4.0K Mar  1 05:53 ..
-rw-r--r--    1 root     root           0 Mar  1 05:53 .lagoon-rootless-migration-complete
-rwxrwxrwx    1 10000    root           8 Mar  1 05:52 chmodfile
drwxr-xr-x    3 10000    root        4.0K Mar  1 05:52 foo
drwxr-xr-x    3 10000    root        4.0K Mar  1 05:53 new
-rw-r--r--    1 10000    root           0 Mar  1 05:53 newfile
-rw-r--r--    1 10000    root           5 Mar  1 05:52 oldfile

/app/web/sites/default/files/foo:
total 16K    
drwxr-xr-x    3 10000    root        4.0K Mar  1 05:52 .
drwxrwxrwx    4 10000    root        4.0K Mar  1 05:53 ..
drwxr-xr-x    2 10000    root        4.0K Mar  1 05:52 bar
-rw-r--r--    1 10000    root           5 Mar  1 05:52 quux

/app/web/sites/default/files/foo/bar:
total 12K    
drwxr-xr-x    2 10000    root        4.0K Mar  1 05:52 .
drwxr-xr-x    3 10000    root        4.0K Mar  1 05:52 ..
-rw-r--r--    1 10000    root           4 Mar  1 05:52 baz

/app/web/sites/default/files/new:
total 12K    
drwxr-xr-x    3 10000    root        4.0K Mar  1 05:53 .
drwxrwxrwx    4 10000    root        4.0K Mar  1 05:53 ..
drwxr-xr-x    2 10000    root        4.0K Mar  1 05:53 dir

/app/web/sites/default/files/new/dir:
total 8K     
drwxr-xr-x    2 10000    root        4.0K Mar  1 05:53 .
drwxr-xr-x    3 10000    root        4.0K Mar  1 05:53 ..
kubectl delete --wait deploy nginx-test
deployment.apps "nginx-test" deleted
kubectl delete --wait pvc nginx-test
persistentvolumeclaim "nginx-test" deleted
